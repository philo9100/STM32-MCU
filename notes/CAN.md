# CAN (Controller Area Network)

[https://blog.csdn.net/XiaoXiaoPengBo/article/details/116206252#:~:text=CAN%20%E6%98%AF%E6%8E%A7%E5%88%B6%E5%99%A8](https://blog.csdn.net/XiaoXiaoPengBo/article/details/116206252#:~:text=CAN%20%E6%98%AF%E6%8E%A7%E5%88%B6%E5%99%A8)

CAN（Controller Area Network）通讯协议是一种用于多主机网络的`串行`通讯协议，广泛应用于汽车、工业自动化和嵌入式系统中。

节点（Node）：CAN网络中的每一个设备称为节点，可以发送和接收信息。
消息（Message）：在CAN网络中，数据以消息的形式传递，每条消息包含一个标识符（ID）、数据和控制信息。

## 物理层概述

与 I2C、SPI 等具有时钟信号的同步通讯方式不同，CAN 通讯并不是以时钟信号来进行同步的，它是一种异步通讯，只具有 CAN_High 和 CAN_Low 两条信号线，共同构成一组差分信号线，以差分信号的形式进行通讯。

一个CAN通讯节点（Node）包含一个CAN控制器，一般由MCU提供以及一个CAN收发器，一般需要专门的芯片提供。

控制器与收发器之间通过CAN_TX和CAN_RX信号线相连，收发器和CAN总线之间使用CAN_H和CAN_L信号线相连。

### CAN节点收发数据

- CAN节点发送数据

    当CAN节点需要发送数据时，控制器把要发送的二进制编码数据以高低电平的形式通过CAN_TX信号线发送到收发器。收发器将这个普通的逻辑电平信号转换成差分信号，通过CAN_H和CAN_L信号线发送到CAN总线。

- CAN节点接收数据

    当CAN节点需要接收数据时，收发器通过CAN_H和CAN_L信号线接收到差分信号，然后将差分信号转换成普通的逻辑电平信号再通过CAN_RX信号线输出一个二进制编码的数据到控制器中。

### CAN总线的网络拓扑结构

- 闭环总线网络

    遵循ISO11898标准的高速、短距离“闭环网络”  
    最大传输距离 40m（总线最大长度为40m）  
    通信速度最高位1Mbps  
    总线的两端各要求有一个120Ω的的电阻  

- 开环总线网络

    遵循ISO11519-2标准的低速、远距离“开环网络”  
    最大传输距离 1km（总线最大长度为1km）  
    通信速度最高为125Kbps  
    两根总线是独立的、不形成闭环，要求每根总线上各串联一个2.2kΩ的电阻

    > 总线终端电阻的作用：
    >
    > 1. 阻抗匹配
    CAN总线的特性阻抗为120欧，终端电阻的作用是匹配总线的特性阻抗，减少信号在总线末端遇到阻抗不匹配时的反射现象。信号反射会导致数据传输错误，影响通信的可靠性。
    >
    > 2. 减少信号反射
    在没有终端电阻的情况下，信号在总线末端遇到阻抗不匹配时，会产生反射，反射信号可能干扰到正在传输的信号，导致接收端无法正确解码数据。终端电阻能够吸收信号，防止反射。

### 差分信号

差分信号又称差模信号，与传统使用单根信号线电压表示逻辑的方式有区别，使用差分信号传输时，需要两根信号线，这两个信号线的振幅相等，相位相反，通过两根信号线的电压差值来表示逻辑 0 和逻辑 1。

相对于单信号线传输的方式，使用差分信号传输具有如下优点：

- 抗干扰能力强，当外界存在噪声干扰时，几乎会同时耦合到两条信号线上，而接收端只关心两个信号的差值，所以外界的共模噪声可以被完全抵消。

    举一个例子，正常的单线假设逻辑1是3.3V，逻辑0假设是0V，但是如果有噪声，把3.3V弄成了0V(极端)，把0V弄成了-3.3V，此时就逻辑错误，但是有CAN_H 和 CAN_L 噪声一般都作用于两根线，所以两个虽然都有噪声影响，但是差值还是不变的

- 能有效抑制它对外部的电磁干扰，同样的道理，由于两根信号的极性相反，他们对外辐射的电磁场可以相互抵消，耦合的越紧密，释放到外界的电磁能量越少。

    举一个例子，假设一根是10V，一根是-10V，单跟都会对外部造成电磁干扰，但是CAN可以把线拧在一起，跟编麻花一样，可以互相抵消电子干扰

- 时序定位精确，由于差分信号的开关变化是位于两个信号的交点，而不像普通单端信号依靠高低两个阈值电压判断，因而受工艺，温度的影响小，能降低时序上的误差，同时也更适合于低幅度信号的电路。

    由于差分信号线具有这些优点，所以在 USB 协议、485 协议、以太网协议及 CAN 协议的物理层中，都使用了差分信号传输。

在电路板上，差分走线必须是等长、等宽、紧密靠近，并且处在同一层的两根线。

### CAN信号定义（以ISO11898高速CAN为例）

- 信号类型：CAN使用差分信号在总线上的节点之间传输数据，即通过两根线（CAN_H和CAN_L）传输信息，增强了抗干扰能力。

    在CAN协议中，差分信号的具体实现如下：

    信号线：CAN收发器使用两根线连接CAN总线来传输差分信号，分别为CAN_H（传输高电压）和CAN_L（传输低电压）。信号的有效信息是这两根线之间的电压差。

- 差分信号电平定义：
  - 显性电平（Dominant State）表示逻辑0：
    - CAN_H电压：通常在2.75V至4.5V之间（典型为3.5V）
    - CAN_L电压：通常在0.5V至2.25V之间（典型为1.5V）
    - 电压差（V_diff = V_CAN_H - V_CAN_L）应大于1.5V，通常在1.5V到2.0V之间。
  - 隐形电平（Recessive State）表示逻辑1：
    - CAN_H电压：通常在2.0V至3.0V之间（典型为2.5V）
    - CAN_L电压：通常在2.0V至3.0V之间（典型为2.5V）
    - 电压差（V_diff）在0V左右，通常是小于0.05V。

- 信号转换过程：
  - 发送逻辑0：

    CAN控制器发送低电平（0V）即逻辑0给收发器，收发器将CAN_H拉高到约3.5V，同时将CAN_L拉低到约1.5V。这种状态下，电压差大于1.5V，表示当前发送的是显性电平即逻辑0。
  
  - 发送逻辑1：

    CAN控制器发送高电平（1V）即逻辑1给收发器，收发器将CAN_H拉高到约2.5V，同时将CAN_L拉低到约2.5V。这种状态下，电压差约为0V左右，表示当前发送的是隐形电平即逻辑1。

在 CAN 总线中，必须使它处于隐性电平（逻辑 1） 或显性电平（逻辑 0）中的其中一个状态。假如有两个 CAN 通讯节点，在同一时间，一个输出隐性电平，另一个输出显性电平，类似 I2C 总线的“线与”特性将使它处于显性电平状态，显性电平的名字就是这样来的，即可以认为显性具有优先的意味。

由于 CAN 总线协议的物理层只有 1 对差分线，在一个时刻只能表示一个信号，所以对通讯节点来说，CAN 通讯是半双工的，收发数据需要分时进行。在 CAN 的通讯网络中，因为共用总线，在整个网络中同一时刻只能有一个通讯节点发送信号，其余的节点在该时刻都只能接收。

## 协议层概述

### CAN 的波特率及位同步

由于 CAN 属于异步通讯，没有时钟信号线，连接在同一个总线网络中的各个节点会像串口异步通讯那样，**节点间使用约定好的波特率进行通讯，特别地，CAN 还会使用“位同步”的方式来抗干扰、吸收误差，实现对总线电平信号进行正确的采样，确保通讯正常。**

### 位时序分解

为了实现位同步，CAN 协议把每一个数据位的时序分解成SS 段、PTS 段、PBS1 段、PBS2 段，这四段的时序长度加起来即为一个 CAN 数据位的时序长度。分解后最小的时间单位是 Tq，而一个完整的位时序由 8~25 个 Tq 组成。信号的采样点位于 PBS1 段与 PBS2 段之间，通过控制各段的时序长度，可以对采样点的位置进行偏移，以便准确地采样。

各时序段的作用：

- SS 段 (SYNC SEG)

SS 译为同步段，若通讯节点检测到总线上信号的跳变沿被包含在 SS 段的范围之内，则表示节点与总线的时序是同步的，当节点与总线同步时，采样点采集到的总线电平即可被确定为该位的电平。SS 段的大小固定为 1Tq。

- PTS 段 (PROP SEG)

PTS 译为传播时间段，这个时间段是用于补偿网络的物理延时时间。是总线上输入比较器延时和输出驱动器延时总和的两倍。PTS 段的大小可以为 1~8Tq。

- PBS1 段 (PHASE SEG1)，

PBS1 译为相位缓冲段，主要用来补偿边沿阶段的误差，它的时间长度在重新同步的时候可以加长。PBS1 段的初始大小可以为 1~8Tq。

- PBS2 段 (PHASE SEG2)

PBS2 这是另一个相位缓冲段，也是用来补偿边沿阶段误差的，它的时间长度在重新同步时可以缩短。PBS2 段的初始大小可以为 2~8Tq。

### 通讯的波特率

总线上的各个通讯节点只要约定好 1 个 Tq 的时间长度以及每一个数据位占据多少个 Tq，就可以确定 CAN 通讯的波特率。

例如，假设1Tq=1us，而每个数据位由 19 个 Tq 组成，则传输一位数据需要时间是19us，从而每秒可以传输的数据位个数为10^6/19

这个每秒可传输的数据位的个数即为通讯中的波特率。

### 同步过程分析
